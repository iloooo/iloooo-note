

## 403 Forbidden 禁止访问

当页面跨域访问触发同源政策，后端服务器没有进行跨域配置时，会返回页面

HTTP/1.1 403 Forbidden 

Invalid CORS request

有时会出现：vary: Origin, Access-Control-Request-Method, Access-Control-Request-Headers



## 同源政策概念

> [阮一峰：浏览器安全的基石同源政策](https://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html)
> [MDN：浏览器的同源策略](https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy)

如果两个 URL 的 域名、端口、协议都相同的话，则这两个 URL 是同源。

浏览器从网页去请求不同域名、端口或协议的资源时**（域名、端口、协议任一不同）**，属于非同源访问，访问会受到限制

> "不同"注意:  域名和域名ip ,localhost和127.0.0.1虽然都指向本机，但也属于跨域

下表给出了与 URL `http://store.company.com/dir/page.html` 的源进行对比的示例:

| URL                                               | 结果 | 原因                               |
| :------------------------------------------------ | :--- | :--------------------------------- |
| `http://store.company.com/dir2/other.html`        | 同源 | 只有路径不同                       |
| `http://store.company.com/dir/inner/another.html` | 同源 | 只有路径不同                       |
| `https://store.company.com/secure.html`           | 失败 | 协议不同                           |
| `http://store.company.com:81/dir/etc.html`        | 失败 | 端口不同 ( `http://` 默认端口是80) |
| `http://news.company.com/dir/other.html`          | 失败 | 主机不同                           |



## 可以跨源访问情况

* 跨域***写操作****（Cross-origin writes）*一般是被允许的*。*例如链接（links），重定向以及表单提交。特定少数的HTTP请求需要添加 [preflight](https://developer.mozilla.org/zh-CN/docs/HTTP/Access_control_CORS#Preflighted_requests)。

* 跨域***资源嵌入**（Cross-origin embedding）*一般是被允许



### 资源嵌入跨源（标签）

- `<script src="..."></script>` 标签嵌入跨域脚本。语法错误信息只能被同源脚本中捕捉到。
- `<link rel="stylesheet" href="...">` 标签嵌入CSS。由于CSS的[松散的语法规则](http://scarybeastsecurity.blogspot.dk/2009/12/generic-cross-browser-cross-domain.html)，CSS的跨域需要一个设置正确的 HTTP 头部 `Content-Type` 。不同浏览器有不同的限制： [IE](http://msdn.microsoft.com/zh-CN/library/ie/gg622939(v=vs.85).aspx), [Firefox](https://www.mozilla.org/security/announce/2010/mfsa2010-46.html), [Chrome](https://code.google.com/p/chromium/issues/detail?id=9877), [Safari](https://support.apple.com/kb/HT4070) (跳至CVE-2010-0051)部分 和 [Opera](https://www.opera.com/support/kb/view/943/)。
- 通过 `<img>` 展示的图片。支持的图片格式包括PNG,JPEG,GIF,BMP,SVG,...
- 通过 `<video>`和`<audio>`播放的多媒体资源。
- 通过 `<object>`、 `<embed>`和 `<applet>` 嵌入的插件。
- 通过 `@font-face` 引入的字体。一些浏览器允许跨域字体（ cross-origin fonts），一些需要同源字体（same-origin fonts）。
- 通过 `<iframe>` 载入的任何资源。站点可以使用 [X-Frame-Options](https://developer.mozilla.org/zh-CN/docs/HTTP/X-Frame-Options) 消息头来阻止这种形式的跨域交互。



### 数据存储跨源（localStorage/IndexedDB/Cookie）

访问存储在浏览器中的数据，如 [localStorage](https://developer.mozilla.org/zh-CN/docs/Web/Guide/API/DOM/Storage) 和 [IndexedDB](https://developer.mozilla.org/zh-CN/docs/IndexedDB)，是以源进行分割。**每个源都拥有自己单独的存储空间**，一个源中的 JavaScript 脚本不能对属于其它源的数据进行读写操作。

[Cookies](https://developer.mozilla.org/zh-CN/docs/Glossary/Cookie) 使用不同的源定义方式。一个页面可以为本域和其父域设置 cookie，只要是父域不是公共后缀（public suffix）即可。不管使用哪个协议（HTTP/HTTPS）或端口号，浏览器都允许给定的域以及其任何子域名(sub-domains) 访问 cookie。当你设置 cookie 时，你可以使用 `Domain`、`Path`、`Secure`、和 `HttpOnly` 标记来限定其可访问性。当你读取 cookie 时，你无法知道它是在哪里被设置的。 即使您只使用安全的 https 连接，您看到的任何 cookie 都有可能是使用不安全的连接进行设置的。



### JavaScript API 跨源（window/location）

为了能让不同源中文档进行交流，可以使用 [`window.postMessage`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage)

**Window对象**

允许以下对 `Window` 属性的跨源访问：

| 方法                                                         |
| :----------------------------------------------------------- |
| [`window.blur`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/blur) |
| [`window.close`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/close) |
| [`window.focus`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/focus) |
| [`window.postMessage`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage) |

| 属性                                                         |        |
| :----------------------------------------------------------- | :----- |
| [`window.closed`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/closed) | 只读.  |
| [`window.frames`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/frames) | 只读.  |
| [`window.length`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/length) | 只读.  |
| [`window.location`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/location) | 读/写. |
| [`window.opener`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/opener) | 只读.  |
| [`window.parent`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/parent) | 只读.  |
| [`window.self`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/self) | 只读.  |
| [`window.top`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/top) | 只读.  |
| [`window.window`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/window) | 只读.  |

**Location对象**

允许以下对 `Location` 属性的跨源访问：

| 方法                                                         |
| :----------------------------------------------------------- |
| [`location.replace`](https://developer.mozilla.org/zh-CN/docs/Web/API/Location/replace) |

| 属性                                                         |       |
| :----------------------------------------------------------- | :---- |
| [`URLUtils.href`](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLAnchorElement/href) | 只写. |



## 非同源行为受到限制（不能共享）:

```
（1） Cookie、LocalStorage 和 IndexDB 无法读取。
（2） DOM 无法获得。Js对象无法获得
（3） AJAX(XMLHttpRequest)和 Fetch请求不能发送。
```



### 跨域解决方案

1、 [JSONP跨域.md](JSONP跨域.md)
2、 todo：document.domain + iframe跨域
3、 todo：location.hash + iframe
4、 todo：window.name + iframe跨域
5、 todo：postMessage跨域
6、 [CORS同源政策和跨域资源共享.md](CORS同源政策和跨域资源共享.md)
7、 todo：nginx代理跨域
8、 todo：nodejs中间件代理跨域
9、 todo：WebSocket协议跨域

